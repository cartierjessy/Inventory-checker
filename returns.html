<script>
document.addEventListener('DOMContentLoaded', () => {
  const $=s=>document.querySelector(s);
  const LS_KEY='parts_inventory_whitetheme_returns_v3';

  // --- storage ---
  function loadStore(){
    try{
      const raw=localStorage.getItem(LS_KEY);
      if(!raw) return { items:[], toReturn:[], pendingRefund:[], archive:[] };
      const parsed=JSON.parse(raw);
      if(Array.isArray(parsed)) return { items:parsed, toReturn:[], pendingRefund:[], archive:[] };
      return Object.assign({ items:[], toReturn:[], pendingRefund:[], archive:[] }, parsed);
    }catch{ return { items:[], toReturn:[], pendingRefund:[], archive:[] }; }
  }
  let STORE=loadStore();
  function saveStore(){ localStorage.setItem(LS_KEY, JSON.stringify(STORE)); renderAll(); }
  function uid(){ return Math.random().toString(36).slice(2,10); }

  // robust HTML escape (prevents rare crashes)
  function esc(s){
    return (s??'').toString().replace(/[&<>"']/g, m => (
      m==='&' ? '&amp;' :
      m==='<' ? '&lt;'  :
      m==='>' ? '&gt;'  :
      m==='"' ? '&quot;': '&#39;'
    ));
  }
  function fmt(v){ return (v??'').toString().trim(); }

  // --- Vendor dropdown (OTHER shows input) ---
  const vendorSel = $('#qaVendorSel');
  const vendorOtherWrap = $('#qaVendorOtherWrap');
  const vendorOther = $('#qaVendorOther');
  vendorSel.addEventListener('change', ()=>{
    const other = vendorSel.value==='OTHER';
    vendorOtherWrap.style.display = other ? 'block' : 'none';
    if(!other) vendorOther.value='';
  });

  // --- Quick add: lookup by Part # from Inventory ---
  $('#qaNumber').addEventListener('change', ()=>{
    const pn = fmt($('#qaNumber').value).toLowerCase();
    if(!pn) return;
    const hit = STORE.items.find(x => String(x.partNumber||'').toLowerCase()===pn);
    if(hit){
      $('#qaPart').value = hit.partName||'';
      const v = (hit.vendor||'').toUpperCase();
      if(['OEM','KEYSTONE','EMPIRE','OTHER'].includes(v)){
        vendorSel.value = v;
        vendorOtherWrap.style.display = (v==='OTHER')?'block':'none';
        if(v==='OTHER') vendorOther.value = hit.vendor;
      } else if(v){
        vendorSel.value = 'OTHER';
        vendorOtherWrap.style.display='block';
        vendorOther.value = hit.vendor;
      }
    }
  });

  // --- Add to "To Return" ---
  $('#qaAdd').addEventListener('click', ()=>{
    const vendor = vendorSel.value==='OTHER' ? fmt(vendorOther.value) : vendorSel.value;
    const rec={ id:uid(),
      partName: fmt($('#qaPart').value), partNumber: fmt($('#qaNumber').value),
      vendor: vendor, qty: Math.max(1, Number($('#qaQty').value||1)),
      price: $('#qaPrice').value? Number($('#qaPrice').value):'',
      invoice: fmt($('#qaInvoice').value),
      notes: fmt($('#qaNotes').value), createdAt: Date.now(), status:'toReturn'
    };
    if(!rec.partName && !rec.partNumber){ alert('Enter at least a Part name or Part #'); return; }
    STORE.toReturn.unshift(rec);
    saveStore();
    // clear form
    ['qaPart','qaNumber','qaQty','qaPrice','qaInvoice','qaNotes','qaVendorOther'].forEach(id=>{ const el=$('#'+id); if(el) el.value=''; });
    vendorSel.value=''; vendorOtherWrap.style.display='none';
    $('#qaQty').value=1;
  });

  // --- Filter/sort (applies to all tables) ---
  $('#filterVendor').addEventListener('change', renderAll);
  $('#sortVendor').addEventListener('change', renderAll);
  function applyFilterSort(list){
    const fv = $('#filterVendor').value;
    const sv = $('#sortVendor').value;
    let out = list.slice();
    if(fv) out = out.filter(r => (r.vendor||'')===fv);
    if(sv==='vendorAsc') out.sort((a,b)=> (a.vendor||'').localeCompare(b.vendor||''));
    if(sv==='vendorDesc') out.sort((a,b)=> (b.vendor||'').localeCompare(a.vendor||'')); 
    if(!sv) out.sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
    return out;
  }

  // --- Renderers ---
  const td = v => `<td>${v}</td>`;
  function rowToReturn(r){
    return `<tr>
      ${td(esc(r.partName||'-'))}
      ${td(esc(r.partNumber||'-'))}
      ${td(esc(r.vendor||'-'))}
      ${td(esc(r.qty||1))}
      ${td(r.price!==''? '$'+Number(r.price).toFixed(2):'-')}
      ${td(esc(r.invoice||'-'))}
      ${td(esc(r.notes||''))}
      <td>
        <button class="good" onclick="openSend('${r.id}')">Mark Sent</button>
        <button onclick="editPending('${r.id}')">Edit</button>
        <button class="danger" onclick="removePending('${r.id}')">Remove</button>
      </td>
    </tr>`;
  }
  function rowPending(r){
    return `<tr>
      ${td(esc(r.partName||'-'))}
      ${td(esc(r.partNumber||'-'))}
      ${td(esc(r.vendor||'-'))}
      ${td(esc(r.qty||1))}
      ${td(r.price!==''? '$'+Number(r.price).toFixed(2):'-')}
      ${td(esc(r.invoice||'-'))}
      ${td(esc(r.driver||'-'))}
      ${td(r.takenAt? new Date(r.takenAt).toLocaleString():'-')}
      <td>
        <button class="warn" onclick="viewSignature('${r.id}')">View Signature</button>
        <button class="good" onclick="markPaid('${r.id}')">Paid â†’ Archive</button>
        <button class="danger" onclick="cancelRefund('${r.id}')">Back to To Return</button>
      </td>
    </tr>`;
  }
  function rowArchive(r){
    return `<tr>
      ${td(esc(r.partName||'-'))}
      ${td(esc(r.partNumber||'-'))}
      ${td(esc(r.vendor||'-'))}
      ${td(esc(r.qty||1))}
      ${td(r.price!==''? '$'+Number(r.price).toFixed(2):'-')}
      ${td(esc(r.invoice||'-'))}
      ${td(esc(r.driver||'-'))}
      ${td(r.paidAt? new Date(r.paidAt).toLocaleString():'-')}
    </tr>`;
  }

  function renderAll(){
    const toR = applyFilterSort(STORE.toReturn);
    const pend = applyFilterSort(STORE.pendingRefund);
    const arch = applyFilterSort(STORE.archive);
    $('#tb-toReturn').innerHTML = toR.length? toR.map(rowToReturn).join('') : `<tr><td class="mini" colspan="8">Empty</td></tr>`;
    $('#tb-pending').innerHTML = pend.length? pend.map(rowPending).join('') : `<tr><td class="mini" colspan="9">Empty</td></tr>`;
    $('#tb-archive').innerHTML = arch.length? arch.map(rowArchive).join('') : `<tr><td class="mini" colspan="8">Empty</td></tr>`;
  }

  // --- Edit/remove To Return ---
  window.editPending = id => {
    const r = STORE.toReturn.find(x=>x.id===id); if(!r) return;
    const fields = [['Part name','partName'],['Part #','partNumber'],['Vendor','vendor'],['Qty','qty'],['Price','price'],['Invoice','invoice'],['Notes','notes']];
    for(const [label,key] of fields){
      const v = prompt(`${label}:`, String(r[key] ?? ''));
      if(v===null) continue;
      if(key==='qty') r[key] = Math.max(1, Number(v||1));
      else if(key==='price') r[key] = v===''? '' : Number(v);
      else r[key] = v;
    }
    saveStore();
  };
  window.removePending = id => { if(confirm('Remove from To Return?')){ STORE.toReturn = STORE.toReturn.filter(x=>x.id!==id); saveStore(); } };

  // --- Signature modal + flow ---
  const sendModal = $('#sendModal');
  const sigPad    = $('#sigPad');
  const ctx       = sigPad.getContext('2d');
  ctx.lineWidth = 2; ctx.lineCap = 'round';

  let drawing=false, last=null, sendCtx={id:null};
  function pos(e){ const r=sigPad.getBoundingClientRect(); const t=e.touches?e.touches[0]:e; return {x:t.clientX-r.left, y:t.clientY-r.top}; }
  function startDraw(e){ drawing=true; last=pos(e); }
  function moveDraw(e){ if(!drawing) return; const p=pos(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; }
  function endDraw(){ drawing=false; }

  sigPad.addEventListener('mousedown',startDraw);
  sigPad.addEventListener('mousemove',moveDraw);
  window.addEventListener('mouseup',endDraw);
  sigPad.addEventListener('touchstart',startDraw,{passive:true});
  sigPad.addEventListener('touchmove',moveDraw,{passive:true});
  sigPad.addEventListener('touchend',endDraw);

  $('#sigClear').addEventListener('click', ()=> ctx.clearRect(0,0,sigPad.width,sigPad.height));

  // Expose open/close on window so inline onclick works
  window.openSend = (id) => {
    sendCtx.id = id;
    $('#sigDriver').value='';
    const now=new Date();
    $('#sigWhen').value=new Date(now.getTime()-now.getTimezoneOffset()*60000).toISOString().slice(0,16);
    $('#sigExtra').value='';
    ctx.clearRect(0,0,sigPad.width,sigPad.height);
    sendModal.style.display='flex';
  };
  window.hideSendModal = () => { sendModal.style.display='none'; };

  $('#sigSave').addEventListener('click', ()=>{
    const rec = STORE.toReturn.find(x=>x.id===sendCtx.id); if(!rec) return;
    const driver = fmt($('#sigDriver').value); if(!driver){ alert('Enter driver name'); return; }
    const when = $('#sigWhen').value ? new Date($('#sigWhen').value).getTime() : Date.now();
    const extra = fmt($('#sigExtra').value);
    const signature = sigPad.toDataURL('image/png');

    const moved = Object.assign({}, rec, { driver, takenAt: when, extra, signature, status:'pendingRefund' });
    STORE.toReturn = STORE.toReturn.filter(x=>x.id!==rec.id);
    STORE.pendingRefund.unshift(moved);
    saveStore();
    sendModal.style.display='none';
  });

  window.viewSignature = id =>{
    const r = STORE.pendingRefund.find(x=>x.id===id); if(!r||!r.signature) return alert('No signature on file.');
    const w = window.open(); w.document.write(`<img src="${r.signature}" style="max-width:100%">`);
  };
  window.cancelRefund = id =>{
    const r = STORE.pendingRefund.find(x=>x.id===id); if(!r) return;
    if(confirm('Move back to To Return?')){
      STORE.pendingRefund = STORE.pendingRefund.filter(x=>x.id!==id);
      delete r.signature; delete r.driver; delete r.takenAt;
      STORE.toReturn.unshift(r); saveStore();
    }
  };
  window.markPaid = id =>{
    const r = STORE.pendingRefund.find(x=>x.id===id); if(!r) return;
    r.paidAt = Date.now();
    STORE.pendingRefund = STORE.pendingRefund.filter(x=>x.id!==id);
    STORE.archive.unshift(r); saveStore();
  };

  // live sync if both tabs open
  window.addEventListener('storage', (e)=>{ if(e.key===LS_KEY){ STORE=loadStore(); renderAll(); }});
  renderAll();
});
</script>
