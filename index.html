<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inventory ‚Ä¢ Shop Parts</title>
<style>
  :root{ --border:#e6edf5; --ink:#0b1220; --muted:#5b6b83; --brand:#0b61ff; --ok:#198754; --warn:#b8860b; --danger:#c0392b; --radius:18px; }
  *{box-sizing:border-box}
  body{margin:0;background:#fff;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1200px;margin:0 auto;padding:24px}
  header{display:flex;gap:14px;align-items:center;justify-content:space-between;margin-bottom:18px}
  h1{margin:0;font-size:20px}
  .badge{background:#e9f7ef;color:#226b3b;border:1px solid #bfe7c9;padding:4px 10px;border-radius:999px;font-size:12px}
  nav a{color:#0b2c66;text-decoration:none;font-weight:600;border:1px solid var(--border);padding:8px 12px;border-radius:10px;background:#f8fbff}
  .grid{display:grid;gap:14px}
  .panels{grid-template-columns:1.1fr .9fr}
  .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:14px;box-shadow:0 10px 35px rgba(0,0,0,.06)}
  .card h2{margin:0 0 10px;font-size:16px;color:#0b2c66}
  label{font-size:12px;color:var(--muted)}
  input,select{width:100%;background:#fff;color:#0b1220;border:1px solid #d7e0ea;border-radius:12px;padding:10px 12px;font-size:14px;outline:none}
  input:focus,select:focus{border-color:#0b61ff;box-shadow:0 0 0 3px rgba(11,97,255,.15)}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
  .col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-5{grid-column:span 5}.col-6{grid-column:span 6}.col-12{grid-column:span 12}
  .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
  button{background:#f5f8ff;border:1px solid #cfe0ff;color:#0b2c66;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
  button.primary{background:#0b61ff;border-color:#0b61ff;color:#fff}
  button.good{background:#198754;color:#fff;border-color:#198754}
  button.warn{background:#b8860b;color:#fff;border-color:#b8860b}
  button.danger{background:#c0392b;color:#fff;border-color:#c0392b}
  button.icon{padding:6px 10px;border-radius:10px}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  thead th{font-size:12px;color:#5b6b83;text-align:left;padding:0 10px}
  tbody td{background:#fff;border:1px solid var(--border);border-left:none;border-right:none;padding:10px;border-radius:10px}
  tbody tr{transition:transform .08s ease}
  tbody tr:hover{transform:translateY(-1px)}
  .pill{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #d6e2f3;color:#1f3c68;background:#eef4ff}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap}
  .toolbar input{max-width:260px}
  .muted{color:#5b6b83}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#fafbff;border:1px solid var(--border);border-radius:6px;padding:2px 6px;color:#0b2c66}
  .erase-fab{position:fixed;left:16px;bottom:16px;z-index:60}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
  .modal .box{background:#fff;border:1px solid var(--border);border-radius:16px;max-width:90vw;max-height:90vh;padding:10px}
  .modal img{max-width:88vw;max-height:80vh;border-radius:12px;display:block}
  @media (max-width:980px){.panels{grid-template-columns:1fr}.col-3,.col-4,.col-5,.col-6{grid-column:span 12}}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="display:flex;align-items:center;gap:10px">
        <h1>Parts Inventory & Vehicle Checker</h1>
        <span class="badge">Offline (this device)</span>
      </div>
      <nav><a href="./returns.html">Open Parts Return ‚Üí</a></nav>
    </header>

    <div class="grid panels">
      <!-- Left: Add / edit -->
      <section class="card">
        <h2>Add / Edit Part</h2>
        <form id="part-form">
          <input type="hidden" id="rowId" />
          <div class="row">
            <div class="col-3">
              <label>Year</label>
              <select id="year"></select>
            </div>
            <div class="col-4">
              <label>Make</label>
              <select id="make"></select>
              <div class="custom-wrap" id="makeCustomWrap" style="display:none"><input id="makeCustom" placeholder="Custom make" /></div>
            </div>
            <div class="col-5">
              <label>Model</label>
              <select id="model"></select>
              <div class="custom-wrap" id="modelCustomWrap" style="display:none"><input id="modelCustom" placeholder="Custom model" /></div>
            </div>

            <div class="col-6">
              <label>Part name</label>
              <input id="partName" placeholder="e.g. Front bumper cover" />
            </div>
            <div class="col-6">
              <label>Part number</label>
              <input id="partNumber" placeholder="e.g. 5G0-807-217-AG" />
            </div>

            <div class="col-4">
              <label>OEM / Aftermarket</label>
              <select id="oem"><option>OEM</option><option>Aftermarket</option></select>
            </div>
            <div class="col-4">
              <label>Condition</label>
              <select id="condition"><option>New</option><option>Used - A</option><option>Used - B</option></select>
            </div>
            <div class="col-4">
              <label>Bin / Location</label>
              <input id="bin" placeholder="e.g. Aisle 2, Bin B4" />
            </div>

            <div class="col-3">
              <label>Qty</label>
              <select id="qty"></select>
              <div class="custom-wrap" id="qtyCustomWrap" style="display:none"><input id="qtyCustom" type="number" min="0" placeholder="Custom qty" /></div>
            </div>
            <div class="col-5">
              <label>Vendor</label>
              <select id="vendor"><option>OEM</option><option>KEYSTONE</option><option>EMPIRE</option><option>OTHER</option></select>
            </div>
            <div class="col-4">
              <label>Photo (optional)</label>
              <input id="photo" type="file" accept="image/*" />
              <div class="muted" style="font-size:12px">If attached, a tiny üñºÔ∏è icon appears in the table.</div>
            </div>

            <div class="col-12">
              <label>Notes</label>
              <input id="notes" placeholder="Any details (color, sensors, trim)" />
            </div>

            <div class="col-12 btns">
              <button type="submit" class="primary" id="btn-save">Save Part (‚åò/Ctrl+S)</button>
              <button type="button" id="btn-reset">Reset</button>
            </div>
          </div>
        </form>
      </section>

      <!-- Right: Vehicle Checker -->
      <section class="card">
        <h2>Vehicle Checker</h2>
        <div class="row">
          <div class="col-3"><label>Year</label><select id="checkYear"></select></div>
          <div class="col-4"><label>Make</label><select id="checkMake"></select></div>
          <div class="col-5"><label>Model</label><select id="checkModel"></select></div>
          <div class="col-12"><label>OR Part number</label><input id="checkPartNumber" placeholder="Type a part # (exact or partial)" /></div>
          <div class="col-12 btns"><button id="btn-check" class="good">Check Vehicle / Part #</button><button id="btn-clear-check">Clear</button></div>
        </div>
        <div id="check-results" style="margin-top:10px"></div>
      </section>
    </div>

    <!-- Inventory Table -->
    <section class="card" style="margin-top:14px">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
        <h2 style="margin-right:auto">Inventory</h2>
        <span class="muted" id="inv-meta"></span>
      </div>
      <div style="overflow:auto">
        <table id="table">
          <thead>
            <tr>
              <th>üì∑</th><th>Y</th><th>Make</th><th>Model</th><th>Part</th><th>#</th><th>OEM/AM</th><th>Cond</th><th>Bin</th><th>Qty</th><th>Vendor</th><th>Notes</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <footer class="muted" style="margin-top:12px">Stored locally on this device. To sync across devices we can wire a backend later.</footer>
  </div>

  <!-- Floating Erase All -->
  <div class="erase-fab"><button id="btn-clear" class="danger">Erase ALL data on this device</button></div>

  <!-- Photo Modal -->
  <div class="modal" id="photoModal" onclick="hideModal()"><div class="box" onclick="event.stopPropagation()"><img id="photoImg" alt="Part photo" /></div></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const $=s=>document.querySelector(s);
  const LS_KEY='parts_inventory_whitetheme_returns_v3';

  function loadStore(){
    try{
      const raw=localStorage.getItem(LS_KEY);
      if(!raw) return { items:[], toReturn:[], pendingRefund:[], archive:[] };
      const parsed=JSON.parse(raw);
      if(Array.isArray(parsed)) return { items:parsed, toReturn:[], pendingRefund:[], archive:[] };
      return Object.assign({ items:[], toReturn:[], pendingRefund:[], archive:[] }, parsed);
    }catch{ return { items:[], toReturn:[], pendingRefund:[], archive:[] }; }
  }
  let STORE=loadStore();
  function saveStore(){ localStorage.setItem(LS_KEY, JSON.stringify(STORE)); render(); }

  const YEARS = Array.from({length:(2025-1990+1)}, (_,i)=> String(1990+i));
  const MAKES = ['Acura','Alfa Romeo','Audi','BMW','Buick','Cadillac','Chevrolet','Chrysler','Dodge','Ford','GMC','Honda','Hyundai','Infiniti','Jaguar','Jeep','Kia','Land Rover','Lexus','Lincoln','Mazda','Mercedes-Benz','Mini','Mitsubishi','Nissan','Porsche','Ram','Subaru','Tesla','Toyota','Volkswagen','Volvo'];
  const MODELS={ 'Volkswagen':['GTI','Golf','Jetta','Passat','Tiguan','Atlas'], 'Dodge':['Durango 392','Charger','Challenger','Ram 1500'], 'Tesla':['Model 3','Model Y','Model S','Model X'], 'BMW':['X5','3 Series','5 Series','X3','X7'], 'Honda':['Civic','Accord','CR-V','Pilot'] };

  let state=STORE.items; let searchTerm=''; let formPhotoData='';

  function buildSelect(el, options, {includeCustom=true}={}){
    el.innerHTML='';
    for(const v of options){ const o=document.createElement('option'); o.value=v; o.textContent=v; el.appendChild(o); }
    if(includeCustom){ const o=document.createElement('option'); o.value='Custom‚Ä¶'; o.textContent='Custom‚Ä¶'; el.appendChild(o); }
  }
  function initDropdowns(){
    buildSelect($('#year'), YEARS, {includeCustom:false});  // Year fixed list
    buildSelect($('#checkYear'), YEARS, {includeCustom:false});
    buildSelect($('#make'), MAKES, {includeCustom:true});
    buildSelect($('#checkMake'), MAKES, {includeCustom:false});
    buildSelect($('#qty'), Array.from({length:21},(_,i)=> String(i)), {includeCustom:true});
    syncModelOptions($('#make').value || 'Volkswagen');
    syncCheckerModels($('#checkMake').value || 'Volkswagen');
  }
  function syncModelOptions(make){
    const sel=$('#model'); const list=MODELS[make]||[];
    if(list.length===0){ buildSelect(sel, ['Custom‚Ä¶'], {includeCustom:false}); toggleCustom('model',true); }
    else { buildSelect(sel, list, {includeCustom:true}); toggleCustom('model',false); }
  }
  function syncCheckerModels(make){
    const sel=$('#checkModel'); const list=MODELS[make]||[]; sel.innerHTML='';
    (list.length?list:['-']).forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; sel.appendChild(o); });
  }
  function toggleCustom(field, show){ const wrap=$('#'+field+'CustomWrap'); if(wrap) wrap.style.display = show ? 'grid':'none'; }
  function setSelectValue(id, value){
    const sel=$('#'+id); const found=[...sel.options].some(o=>o.value===value);
    if(found){ sel.value=value; toggleCustom(id,false); }
    else { sel.value='Custom‚Ä¶'; toggleCustom(id,true); const c=$('#'+id+'Custom'); if(c) c.value=value; }
  }
  function fmt(v){ return (v??'').toString().trim(); }
  function uid(){ return Math.random().toString(36).slice(2,10); }
  function esc(s){ return (s??'').toString().replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;","\">":"&quot;","'":"&#39;",">":"&gt;"}[m])); }

  // Photo
  $('#photo').addEventListener('change', async (e)=>{
    const f=e.target.files && e.target.files[0]; if(!f){ formPhotoData=''; return; }
    const dataURL=await new Promise((resolve,reject)=>{
      const r=new FileReader();
      r.onload=()=>{
        const img=new Image();
        img.onload=()=>{
          const scale=Math.min(1, 1200/img.width);
          if(scale>=1) return resolve(r.result);
          const c=document.createElement('canvas'); c.width=Math.round(img.width*scale); c.height=Math.round(img.height*scale);
          c.getContext('2d').drawImage(img,0,0,c.width,c.height);
          resolve(c.toDataURL('image/jpeg',0.85));
        };
        img.onerror=()=>resolve(r.result);
        img.src=r.result;
      };
      r.onerror=reject; r.readAsDataURL(f);
    });
    formPhotoData=dataURL;
  });

  // CRUD
  function readForm(){
    return {
      id: $('#rowId').value || uid(),
      year: $('#year').value,
      make: getValue('make'),
      model: getValue('model'),
      partName: fmt($('#partName').value),
      partNumber: fmt($('#partNumber').value),
      oem: $('#oem').value,
      condition: $('#condition').value,
      bin: fmt($('#bin').value),
      qty: Number($('#qty').value==='Custom‚Ä¶' ? ($('#qtyCustom').value||0) : $('#qty').value),
      vendor: $('#vendor').value,
      notes: fmt($('#notes').value),
      photo: formPhotoData || undefined,
      createdAt: Date.now(), updatedAt: Date.now()
    };
  }
  function getValue(selId){
    const sel=$('#'+selId);
    if(sel.value==='Custom‚Ä¶'){ const v=fmt($('#'+selId+'Custom').value); return v || 'Custom'; }
    return sel.value;
  }
  function fillForm(r){
    $('#rowId').value=r.id;
    setSelectValue('year', r.year);
    setSelectValue('make', r.make); syncModelOptions($('#make').value);
    setSelectValue('model', r.model);
    $('#partName').value=r.partName; $('#partNumber').value=r.partNumber; $('#oem').value=r.oem; $('#condition').value=r.condition; $('#bin').value=r.bin;
    setSelectValue('qty', String(r.qty)); if($('#qty').value==='Custom‚Ä¶'){ $('#qtyCustom').value=r.qty; }
    $('#vendor').value=r.vendor; $('#notes').value=r.notes; formPhotoData=r.photo||''; $('#photo').value='';
  }
  function clearForm(){ $('#part-form').reset(); $('#rowId').value=''; formPhotoData=''; toggleCustom('make',false); toggleCustom('model',false); toggleCustom('qty',false); }
  function upsert(row){
    const i=state.findIndex(r=>r.id===row.id);
    if(i>=0){ row.createdAt=state[i].createdAt; row.updatedAt=Date.now(); state[i]=row; }
    else state.unshift(row);
    // *** FIXED LINE BELOW (was `r.row`) ***
    if(row.make){ 
      if(!MAKES.includes(row.make) && row.make!=='Custom'){ MAKES.push(row.make); }
      MODELS[row.make]=MODELS[row.make]||[];
      if(row.model && !MODELS[row.make].includes(row.model)){ MODELS[row.make].push(row.model); }
    }
    STORE.items = state; saveStore(); clearForm(); initDropdowns();
  }
  function removeItem(id){ state = state.filter(r=>r.id!==id); STORE.items=state; saveStore(); }

  function rowHtml(r){
    const hasPhoto=!!r.photo;
    return `<tr>
      <td>${hasPhoto?`<button class="icon" title="View photo" onclick="showPhoto('${r.id}')">üñºÔ∏è</button>`:''}</td>
      <td>${esc(r.year)}</td><td>${esc(r.make)}</td><td>${esc(r.model)}</td>
      <td>${esc(r.partName)}</td>
      <td><code class="kbd">${esc(r.partNumber)}</code></td>
      <td>${esc(r.oem)}</td><td>${esc(r.condition)}</td><td>${esc(r.bin)}</td>
      <td>${r.qty}</td><td>${esc(r.vendor)}</td><td>${esc(r.notes)}</td>
      <td>
        <button onclick="editRow('${r.id}')">Edit</button>
        <button class="warn" onclick="startReturn('${r.id}')">Return</button>
        <button class="danger" onclick="deleteRow('${r.id}')">Delete</button>
      </td>
    </tr>`;
  }
  function matchesSearch(r,q){
    if(!q) return true; q=q.toLowerCase();
    const A=[r.year,r.make,r.model,r.partName,r.partNumber,r.oem,r.condition,r.bin,r.vendor,r.notes,r.qty].map(x=>String(x||'').toLowerCase());
    return A.some(f=>f.includes(q));
  }
  function render(){
    const filtered = state.filter(r=> matchesSearch(r, searchTerm));
    document.querySelector('#table tbody').innerHTML = filtered.map(r=> rowHtml(r)).join('') || `<tr><td class="muted" colspan="13">No parts yet. Add with the form above.</td></tr>`;
    document.querySelector('#inv-meta').textContent = `${filtered.length} shown / ${state.length} total`;
  }

  // global handlers
  window.editRow=id=>{ const r=state.find(x=>x.id===id); if(r){ fillForm(r); window.scrollTo({top:0,behavior:'smooth'}); } };
  window.deleteRow=id=>{ if(confirm('Delete this part?')) removeItem(id); };
  window.showPhoto=id=>{ const r=state.find(x=>x.id===id); if(!r||!r.photo) return; document.querySelector('#photoImg').src=r.photo; document.querySelector('#photoModal').style.display='flex'; };
  window.hideModal=()=> document.querySelector('#photoModal').style.display='none';

  function startReturn(id){
    const r=state.find(x=>x.id===id); if(!r) return;
    const rec={ id: uid(), itemId:r.id, partName:r.partName, partNumber:r.partNumber, vendor:r.vendor, qty:Math.max(1,Number(r.qty||1)), notes:`From inventory bin ${r.bin||'-'}`, price:'', invoice:'', createdAt:Date.now(), status:'toReturn' };
    STORE.toReturn.unshift(rec); saveStore();
    if(confirm('Added to Parts Return. Open the Returns page?')) location.href='./returns.html';
  }
  window.startReturn=startReturn;

  // events
  document.querySelector('#part-form').addEventListener('submit', e=>{ e.preventDefault(); const row=readForm(); if(!row.partName){ alert('Part Name is required'); return; } upsert(row); });
  document.querySelector('#btn-reset').addEventListener('click', clearForm);
  document.addEventListener('keydown', e=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); document.querySelector('#btn-save').click(); }});
  document.querySelector('#make').addEventListener('change', e=>{ toggleCustom('make', e.target.value==='Custom‚Ä¶'); syncModelOptions(e.target.value); });
  document.querySelector('#model').addEventListener('change', e=> toggleCustom('model', e.target.value==='Custom‚Ä¶'));
  document.querySelector('#qty').addEventListener('change', e=> toggleCustom('qty', e.target.value==='Custom‚Ä¶'));

  // vehicle checker
  document.querySelector('#checkMake').addEventListener('change', e=> syncCheckerModels(e.target.value));
  document.querySelector('#btn-check').addEventListener('click', ()=> {
    const pn = fmt(document.querySelector('#checkPartNumber').value).toLowerCase(); let results=[];
    if(pn){ results = state.filter(r=> String(r.partNumber||'').toLowerCase().includes(pn)); }
    else{
      const y=document.querySelector('#checkYear').value, mk=document.querySelector('#checkMake').value, md=document.querySelector('#checkModel').value;
      results = state.filter(r=>{
        const yOk = y? String(r.year)===String(y):true;
        const mOk = mk && mk!=='-'? String(r.make||'')===mk:true;
        const dOk = md && md!=='-'? String(r.model||'')===md:true;
        return yOk&&mOk&&dOk;
      });
    }
    const box=document.querySelector('#check-results');
    if(results.length===0){ box.innerHTML='<div class="muted">No matches found.</div>'; return; }
    box.innerHTML = `<div style="margin-bottom:8px">Found <b>${results.length}</b> matching part(s):</div>` +
      `<div style="display:grid;gap:10px">` +
      results.map(r=>`<div class="card" style="padding:10px">
        <div style="display:flex;gap:8px;align-items:center">
          <span class="pill">${esc(r.year)} ${esc(r.make)} ${esc(r.model)}</span>
          <span class="pill">Bin: ${esc(r.bin||'-')}</span>
          <span class="pill">Qty: ${r.qty}</span>
        </div>
        <div style="margin-top:6px"><b>${esc(r.partName)}</b> <span class="muted">#${esc(r.partNumber||'-')}</span></div>
        <div class="muted">${esc(r.oem)} ‚Ä¢ ${esc(r.condition)} ‚Ä¢ Vendor: ${esc(r.vendor||'-')}</div>
      </div>`).join('') + `</div>`;
  });
  document.querySelector('#btn-clear-check').addEventListener('click', ()=>{ document.querySelector('#checkYear').value=''; document.querySelector('#checkMake').value=''; document.querySelector('#checkModel').innerHTML=''; document.querySelector('#checkPartNumber').value=''; document.querySelector('#check-results').innerHTML=''; });

  // init
  initDropdowns(); render();
});
</script>
</body>
</html>
