<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shop Parts Inventory & Vehicle Checker</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#101620; --panel-2:#0f141c; --text:#e8eef6; --muted:#9fb1c7; --accent:#3aa0ff; --accent-2:#65d38e; --warn:#ffb020; --danger:#ff6b6b;
      --br:18px; --pad:14px; --gap:14px; --shadow: 0 10px 40px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(120deg,#0a0e13,#0d131b);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    header{display:flex;gap:var(--gap);align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0;letter-spacing:.2px}
    .badge{background:rgba(101,211,142,.15);color:#c9f5de;border:1px solid rgba(101,211,142,.4);padding:4px 10px;border-radius:999px;font-size:12px}
    .grid{display:grid;gap:var(--gap)}
    .panels{grid-template-columns:1.1fr .9fr}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid #1b2533;border-radius:var(--br);padding:var(--pad);box-shadow:var(--shadow)}
    .card h2{margin:0 0 10px;font-size:16px;color:#cfe4ff}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;background:#0c121a;color:var(--text);border:1px solid #263448;border-radius:12px;padding:10px 12px;font-size:14px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(58,160,255,.2)}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .col-3{grid-column:span 3}
    .col-2{grid-column:span 2}
    .col-4{grid-column:span 4}
    .col-5{grid-column:span 5}
    .col-6{grid-column:span 6}
    .col-12{grid-column:span 12}
    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    button{background:linear-gradient(180deg,#1a2330,#16202e);border:1px solid #2a3b50;color:var(--text);padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    button.primary{background:linear-gradient(180deg,#1570ff,#0f5fe0);border-color:#1a6dff}
    button.good{background:linear-gradient(180deg,#1b7a50,#166340)}
    button.warn{background:linear-gradient(180deg,#7a5b1b,#664a15)}
    button.danger{background:linear-gradient(180deg,#7a1b28,#651622)}
    button.icon{padding:6px 10px;border-radius:10px}
    button:disabled{opacity:.6;cursor:not-allowed}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{font-size:12px;color:#9fb1c7;text-align:left;padding:0 10px}
    tbody td{background:#0d141d;border:1px solid #1f2b3a;border-left:none;border-right:none;padding:10px;border-radius:10px}
    tbody tr{transition:transform .08s ease}
    tbody tr:hover{transform:translateY(-1px)}
    .pill{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #28435d;color:#b7d7ff;background:#0b1c30}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .toolbar input{max-width:260px}
    .muted{color:var(--muted)}
    .right{margin-left:auto}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#06090e;border:1px solid #1c2836;border-radius:6px;padding:2px 6px;color:#cfe4ff}
    footer{margin-top:18px;color:#7d91ab;font-size:12px}
    .note{font-size:12px;color:#c9d6e6}
    .hint{font-size:12px;color:#9fb1c7;margin-top:6px}
    .custom-wrap{display:none;gap:8px;margin-top:8px}

    /* Photo */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
    .modal .box{background:#0f141c;border:1px solid #223045;border-radius:16px;max-width:90vw;max-height:90vh;padding:10px}
    .modal img{max-width:88vw;max-height:80vh;border-radius:12px;display:block}

    /* Floating Erase button */
    .erase-fab{position:fixed;left:16px;bottom:16px;z-index:60}

    @media (max-width: 980px){
      .panels{grid-template-columns:1fr}
      .col-3,.col-2,.col-4,.col-5,.col-6{grid-column:span 12}
      .toolbar{flex-direction:column;align-items:stretch}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="display:flex;align-items:center;gap:10px">
        <h1>Parts Inventory & Vehicle Checker</h1>
        <span class="badge">Offline / saves to your device</span>
      </div>
      <div class="toolbar">
        <input id="search" type="search" placeholder="Search parts (part #, name, Y/M/M, vendor, bin, notes)" />
      </div>
    </header>

    <div class="grid panels">
      <!-- Left: Add / edit -->
      <section class="card">
        <h2>Add / Edit Part</h2>
        <form id="part-form">
          <input type="hidden" id="rowId" />
          <div class="row">
            <div class="col-3">
              <label>Year</label>
              <select id="year"></select>
              <div class="custom-wrap" id="yearCustomWrap">
                <input id="yearCustom" placeholder="Custom year" />
              </div>
            </div>
            <div class="col-4">
              <label>Make</label>
              <select id="make"></select>
              <div class="custom-wrap" id="makeCustomWrap">
                <input id="makeCustom" placeholder="Custom make" />
              </div>
            </div>
            <div class="col-5">
              <label>Model</label>
              <select id="model"></select>
              <div class="custom-wrap" id="modelCustomWrap">
                <input id="modelCustom" placeholder="Custom model" />
              </div>
            </div>

            <div class="col-6">
              <label>Part name</label>
              <input id="partName" placeholder="e.g. Front bumper cover" />
            </div>
            <div class="col-6">
              <label>Part number</label>
              <input id="partNumber" placeholder="e.g. 5G0-807-217-AG" />
            </div>

            <div class="col-4">
              <label>OEM / Aftermarket</label>
              <select id="oem">
                <option value="OEM">OEM</option>
                <option value="Aftermarket">Aftermarket</option>
              </select>
            </div>
            <div class="col-4">
              <label>Condition</label>
              <select id="condition">
                <option>New</option>
                <option>Used - A</option>
                <option>Used - B</option>
              </select>
            </div>
            <div class="col-4">
              <label>Bin / Location</label>
              <input id="bin" placeholder="e.g. Aisle 2, Bin B4" />
            </div>

            <div class="col-3">
              <label>Qty</label>
              <select id="qty"></select>
              <div class="custom-wrap" id="qtyCustomWrap">
                <input id="qtyCustom" type="number" min="0" placeholder="Custom qty" />
              </div>
            </div>
            <div class="col-5">
              <label>Vendor</label>
              <select id="vendor">
                <option>OEM</option>
                <option>KEYSTONE</option>
                <option>EMPIRE</option>
                <option>OTHER</option>
              </select>
            </div>
            <div class="col-4">
              <label>Photo (optional)</label>
              <input id="photo" type="file" accept="image/*" />
              <div class="hint">If added, you’ll see a small photo icon in the table. Click it to preview. (Photos are stored locally and not included in CSV export.)</div>
            </div>

            <div class="col-12">
              <label>Notes</label>
              <input id="notes" placeholder="Any details (color, sensors, trim)" />
            </div>

            <div class="col-12 btns">
              <button type="submit" class="primary" id="btn-save">Save Part (⌘/Ctrl+S)</button>
              <button type="button" id="btn-reset">Reset</button>
            </div>
          </div>
        </form>
      </section>

      <!-- Right: Vehicle Checker -->
      <section class="card">
        <h2>Vehicle Checker (Do I stock parts for this car?)</h2>
        <div class="row">
          <div class="col-3">
            <label>Year</label>
            <select id="checkYear"></select>
          </div>
          <div class="col-4">
            <label>Make</label>
            <select id="checkMake"></select>
          </div>
          <div class="col-5">
            <label>Model</label>
            <select id="checkModel"></select>
          </div>
          <div class="col-12">
            <label>OR Part number</label>
            <input id="checkPartNumber" placeholder="Type a part # (exact or partial)" />
          </div>
          <div class="col-12 btns">
            <button id="btn-check" class="good">Check Vehicle / Part #</button>
            <button id="btn-clear-check">Clear</button>
          </div>
        </div>
        <div id="check-results" style="margin-top:10px"></div>
      </section>
    </div>

    <!-- Table -->
    <section class="card" style="margin-top:14px">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
        <h2 style="margin-right:auto">Inventory</h2>
        <span class="muted" id="inv-meta"></span>
      </div>
      <div style="overflow:auto">
        <table id="table">
          <thead>
            <tr>
              <th>📷</th><th>Y</th><th>Make</th><th>Model</th><th>Part</th><th>#</th><th>OEM/AM</th><th>Cond</th><th>Bin</th><th>Qty</th><th>Vendor</th><th>Notes</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <footer>
      <div>All data is stored locally on this device (<span class="kbd">localStorage</span>). Photos stay local; CSV import/export removed per your request.</div>
    </footer>
  </div>

  <!-- Floating Erase All button -->
  <div class="erase-fab">
    <button id="btn-clear" class="danger">Erase ALL data on this device</button>
  </div>

  <!-- Photo Modal -->
  <div class="modal" id="photoModal" onclick="hideModal()">
    <div class="box" onclick="event.stopPropagation()">
      <img id="photoImg" alt="Part photo" />
    </div>
  </div>

  <script>
  // ====== Helpers ======
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const LS_KEY = 'parts_inventory_v3_photos_minimal';

  // Master lists for dropdowns
  const YEARS = Array.from({length: 50}, (_,i)=> String(1990 + i));
  const MAKES = ['Acura','Alfa Romeo','Audi','BMW','Buick','Cadillac','Chevrolet','Chrysler','Dodge','Ford','GMC','Honda','Hyundai','Infiniti','Jaguar','Jeep','Kia','Land Rover','Lexus','Lincoln','Mazda','Mercedes-Benz','Mini','Mitsubishi','Nissan','Porsche','Ram','Subaru','Tesla','Toyota','Volkswagen','Volvo'];
  const MODELS = {
    'Volkswagen':['GTI','Golf','Jetta','Passat','Tiguan','Atlas'],
    'Dodge':['Durango 392','Charger','Challenger','Ram 1500'],
    'Tesla':['Model 3','Model Y','Model S','Model X'],
    'BMW':['X5','3 Series','5 Series','X3','X7'],
    'Honda':['Civic','Accord','CR-V','Pilot']
  };

  let state = load();
  let searchTerm = '';
  let formPhotoData = '';

  const form = $('#part-form');
  const tbody = $('#table tbody');
  const invMeta = $('#inv-meta');

  function load(){
    try{ return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); }
    catch{ return []; }
  }
  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); render(); }

  function fmt(v){ return (v??'').toString().trim(); }
  function uid(){ return Math.random().toString(36).slice(2,10); }

  // ====== Dropdown init ======
  function buildSelect(el, options, {includeCustom=true}={}){
    el.innerHTML = '';
    const opt = (v)=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; return o; };
    options.forEach(v=> el.appendChild(opt(v)));
    if(includeCustom) el.appendChild(opt('Custom…'));
  }
  function initDropdowns(){
    buildSelect($('#year'), YEARS, {includeCustom:true});
    buildSelect($('#checkYear'), YEARS, {includeCustom:false});
    buildSelect($('#make'), MAKES, {includeCustom:true});
    buildSelect($('#checkMake'), MAKES, {includeCustom:false});
    buildSelect($('#qty'), Array.from({length:21},(_,i)=> String(i)), {includeCustom:true});
    syncModelOptions($('#make').value || 'Volkswagen');
    syncCheckerModels($('#checkMake').value || 'Volkswagen');
  }
  function syncModelOptions(make){
    const sel = $('#model');
    const list = MODELS[make] || [];
    if(list.length===0){ buildSelect(sel, ['Custom…'], {includeCustom:false}); toggleCustom('model', true); }
    else { buildSelect(sel, list, {includeCustom:true}); toggleCustom('model', false); }
  }
  function syncCheckerModels(make){
    const sel = $('#checkModel');
    const list = MODELS[make] || [];
    sel.innerHTML = '';
    (list.length?list:['-']).forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; sel.appendChild(o); });
  }

  // Show/hide custom inputs when "Custom…" chosen
  function toggleCustom(field, show){
    const wrap = $('#' + field + 'CustomWrap');
    if(!wrap) return;
    wrap.style.display = show ? 'grid' : 'none';
  }
  function getValue(selId){
    const sel = $('#' + selId);
    if(sel.value === 'Custom…'){
      const val = fmt($('#' + selId + 'Custom').value);
      return val || 'Custom';
    }
    return sel.value;
  }

  // ====== Photo handling ======
  $('#photo').addEventListener('change', async (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) { formPhotoData=''; return; }
    const dataURL = await fileToDataURL(file, 1200);
    formPhotoData = dataURL;
  });
  function fileToDataURL(file, maxW){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = ()=>{
        const img = new Image();
        img.onload = ()=>{
          const scale = Math.min(1, maxW / img.width);
          if(scale >= 1){ return resolve(reader.result); }
          const c = document.createElement('canvas');
          c.width = Math.round(img.width * scale);
          c.height = Math.round(img.height * scale);
          const ctx = c.getContext('2d');
          ctx.drawImage(img,0,0,c.width,c.height);
          resolve(c.toDataURL('image/jpeg', 0.85));
        };
        img.onerror = ()=> resolve(reader.result);
        img.src = reader.result;
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // ====== Read / Fill / Clear ======
  function readForm(){
    return {
      id: $('#rowId').value || uid(),
      year: getValue('year'),
      make: getValue('make'),
      model: getValue('model'),
      partName: fmt($('#partName').value),
      partNumber: fmt($('#partNumber').value),
      oem: fmt($('#oem').value),
      condition: fmt($('#condition').value),
      bin: fmt($('#bin').value),
      qty: Number($('#qty').value === 'Custom…' ? ($('#qtyCustom').value||0) : $('#qty').value),
      vendor: fmt($('#vendor').value),
      notes: fmt($('#notes').value),
      photo: formPhotoData || undefined,
      createdAt: Date.now(),
      updatedAt: Date.now(),
    };
  }
  function fillForm(r){
    $('#rowId').value=r.id;
    setSelectValue('year', r.year);
    setSelectValue('make', r.make);
    syncModelOptions($('#make').value);
    setSelectValue('model', r.model);
    $('#partName').value=r.partName; $('#partNumber').value=r.partNumber;
    $('#oem').value=r.oem; $('#condition').value=r.condition; $('#bin').value=r.bin;
    setSelectValue('qty', String(r.qty)); if($('#qty').value==='Custom…'){ $('#qtyCustom').value=r.qty; }
    $('#vendor').value=r.vendor; $('#notes').value=r.notes;
    formPhotoData = r.photo || '';
    $('#photo').value = '';
  }
  function setSelectValue(id, value){
    const sel = $('#'+id);
    const found = [...sel.options].some(o=> o.value===value);
    if(found){ sel.value=value; toggleCustom(id, false); }
    else { sel.value='Custom…'; toggleCustom(id, true); const custom=$('#'+id+'Custom'); if(custom) custom.value=value; }
  }
  function clearForm(){ form.reset(); $('#rowId').value=''; formPhotoData=''; toggleCustom('year', false); toggleCustom('make', false); toggleCustom('model', false); toggleCustom('qty', false); }

  // ====== CRUD ======
  function upsert(row){
    const i = state.findIndex(r=>r.id===row.id);
    if(i>=0){ row.createdAt = state[i].createdAt; row.updatedAt = Date.now(); state[i]=row; }
    else state.unshift(row);
    if(!MAKES.includes(row.make) && row.make && row.make!=='Custom'){ MAKES.push(row.make); }
    if(row.make){ MODELS[row.make] = MODELS[row.make] || []; if(!MODELS[row.make].includes(row.model) && row.model){ MODELS[row.make].push(row.model); } }
    save(); clearForm(); initDropdowns();
  }
  function remove(id){ state = state.filter(r=>r.id!==id); save(); }

  // ====== Render ======
  function render(){
    const filtered = state.filter(r=> matchesSearch(r, searchTerm));
    tbody.innerHTML = filtered.map(r=> rowHtml(r)).join('') || `<tr><td class="muted" colspan="13">No parts yet. Add with the form above.</td></tr>`;
    invMeta.textContent = `${filtered.length} shown / ${state.length} total`;
  }
  function matchesSearch(r, q){
    if(!q) return true; q=q.toLowerCase();
    const fields = [r.year,r.make,r.model,r.partName,r.partNumber,r.oem,r.condition,r.bin,r.vendor,r.notes,r.qty].map(x=>String(x||'').toLowerCase());
    return fields.some(f=> f.includes(q));
  }
  function rowHtml(r){
    const hasPhoto = !!r.photo;
    return `<tr>
      <td>${hasPhoto?`<button class="icon" title="View photo" onclick="showPhoto('${r.id}')">🖼️</button>`:''}</td>
      <td>${esc(r.year)}</td>
      <td>${esc(r.make)}</td>
      <td>${esc(r.model)}</td>
      <td>${esc(r.partName)}</td>
      <td><code class="kbd">${esc(r.partNumber)}</code></td>
      <td>${esc(r.oem)}</td>
      <td>${esc(r.condition)}</td>
      <td>${esc(r.bin)}</td>
      <td>${r.qty}</td>
      <td>${esc(r.vendor)}</td>
      <td>${esc(r.notes)}</td>
      <td>
        <button onclick="editRow('${r.id}')">Edit</button>
        <button class="danger" onclick="deleteRow('${r.id}')">Delete</button>
      </td>
    </tr>`
  }
  function esc(s){ return (s??'').toString().replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
  window.editRow = id => { const r=state.find(x=>x.id===id); if(r){ fillForm(r); window.scrollTo({top:0,behavior:'smooth'});} };
  window.deleteRow = id => { if(confirm('Delete this part?')) remove(id); };
  window.showPhoto = id => { const r=state.find(x=>x.id===id); if(!r||!r.photo) return; $('#photoImg').src=r.photo; $('#photoModal').style.display='flex'; };
  window.hideModal = ()=> { $('#photoModal').style.display='none'; };

  // ====== Events ======
  form.addEventListener('submit', e=>{ e.preventDefault(); const row = readForm();
    if(!row.partName){ alert('Part Name is required'); return; }
    if(!row.make || !row.model){ if(!confirm('Make/Model empty or Custom. Save anyway?')) return; }
    upsert(row);
  });
  $('#btn-reset').addEventListener('click', clearForm);
  document.addEventListener('keydown', e=>{ if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='s'){ e.preventDefault(); $('#btn-save').click(); }});
  $('#search').addEventListener('input', e=>{ searchTerm = e.target.value; render(); });

  // Toggling custom inputs
  $('#year').addEventListener('change', e=> toggleCustom('year', e.target.value==='Custom…'));
  $('#make').addEventListener('change', e=> { toggleCustom('make', e.target.value==='Custom…'); syncModelOptions(e.target.value); });
  $('#model').addEventListener('change', e=> toggleCustom('model', e.target.value==='Custom…'));
  $('#qty').addEventListener('change', e=> toggleCustom('qty', e.target.value==='Custom…'));

  // Floating Erase button
  $('#btn-clear').addEventListener('click', ()=>{
    if(confirm('This erases ALL saved parts (including photos) on THIS device. Proceed?')){
      state = []; save(); initDropdowns();
    }
  });

  // Vehicle checker with Part# override
  $('#checkMake').addEventListener('change', e=> syncCheckerModels(e.target.value));
  $('#btn-check').addEventListener('click', ()=>{
    const pn = fmt($('#checkPartNumber').value).toLowerCase();
    let results = [];
    if(pn){
      results = state.filter(r=> String(r.partNumber||'').toLowerCase().includes(pn));
    } else {
      const y = $('#checkYear').value, mk = $('#checkMake').value, md = $('#checkModel').value;
      results = state.filter(r=>{
        const yOk = y ? String(r.year)===String(y) : true;
        const mOk = mk && mk!=='-' ? String(r.make||'')===mk : true;
        const dOk = md && md!=='-' ? String(r.model||'')===md : true;
        return yOk && mOk && dOk;
      });
    }
    const box = $('#check-results');
    if(results.length===0){ box.innerHTML = `<div class="muted">No matches found.</div>`; return; }
    box.innerHTML = `<div style="margin-bottom:8px">Found <b>${results.length}</b> matching part(s):</div>` +
      `<div style="display:grid;gap:10px">`+
      results.map(r=>`<div class="card" style="padding:10px">`+
        `<div style="display:flex;gap:8px;align-items:center"><span class="pill">${esc(r.year)} ${esc(r.make)} ${esc(r.model)}</span>`+
        `<span class="pill">Bin: ${esc(r.bin||'-')}</span>`+
        `<span class="pill">Qty: ${r.qty}</span>`+
        `</div>`+
        `<div style="margin-top:6px"><b>${esc(r.partName)}</b> <span class="muted">#${esc(r.partNumber||'-')}</span></div>`+
        `<div class="muted">${esc(r.oem)} • ${esc(r.condition)} • Vendor: ${esc(r.vendor||'-')}</div>`+
      `</div>`).join('')+
      `</div>`;
  });
  $('#btn-clear-check').addEventListener('click', ()=>{ $('#checkYear').value=''; $('#checkMake').value=''; $('#checkModel').innerHTML=''; $('#checkPartNumber').value=''; $('#check-results').innerHTML=''; });

  // Kickoff
  initDropdowns();
  render();
  </script>
</body>
</html>
