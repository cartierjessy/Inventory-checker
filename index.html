<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shop Parts Inventory & Vehicle Checker</title>
  <style>
    /* --- Clean white theme (watermark removed) --- */
    :root{ --border:#e6edf5; --ink:#0b1220; --muted:#5b6b83; --brand:#0b61ff; --ok:#198754; --warn:#b8860b; --danger:#c0392b; --radius:18px; }
    *{box-sizing:border-box}
    body{margin:0;background:#fff;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    header{display:flex;gap:14px;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0;letter-spacing:.2px}
    .badge{background:#e9f7ef;color:#226b3b;border:1px solid #bfe7c9;padding:4px 10px;border-radius:999px;font-size:12px}
    .grid{display:grid;gap:14px}
    .panels{grid-template-columns:1.1fr .9fr}
    .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:14px;box-shadow:0 10px 35px rgba(0,0,0,.06)}
    .card h2{margin:0 0 10px;font-size:16px;color:#0b2c66}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;background:#fff;color:var(--ink);border:1px solid #d7e0ea;border-radius:12px;padding:10px 12px;font-size:14px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(11,97,255,.15)}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .col-3{grid-column:span 3}.col-2{grid-column:span 2}.col-4{grid-column:span 4}.col-5{grid-column:span 5}.col-6{grid-column:span 6}.col-12{grid-column:span 12}
    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    button{background:#f5f8ff;border:1px solid #cfe0ff;color:#0b2c66;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    button.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    button.good{background:var(--ok);color:#fff;border-color:var(--ok)}
    button.warn{background:var(--warn);color:#fff;border-color:var(--warn)}
    button.danger{background:var(--danger);color:#fff;border-color:var(--danger)}
    button.icon{padding:6px 10px;border-radius:10px}
    button:disabled{opacity:.6;cursor:not-allowed}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{font-size:12px;color:var(--muted);text-align:left;padding:0 10px}
    tbody td{background:#fff;border:1px solid var(--border);border-left:none;border-right:none;padding:10px;border-radius:10px}
    tbody tr{transition:transform .08s ease}
    tbody tr:hover{transform:translateY(-1px)}
    .pill{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #d6e2f3;color:#1f3c68;background:#eef4ff}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .toolbar input{max-width:260px}
    .muted{color:var(--muted)}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#fafbff;border:1px solid var(--border);border-radius:6px;padding:2px 6px;color:#0b2c66}
    footer{margin-top:18px;color:var(--muted);font-size:12px}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .custom-wrap{display:none;gap:8px;margin-top:8px}
    /* Modal (photo + signature) */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
    .modal .box{background:#fff;border:1px solid var(--border);border-radius:16px;max-width:95vw;max-height:95vh;padding:12px}
    .modal img{max-width:88vw;max-height:80vh;border-radius:12px;display:block}
    .erase-fab{position:fixed;left:16px;bottom:16px;z-index:60}
    .section-title{display:flex;align-items:center;gap:8px;margin:4px 0 10px}
    .section-title h3{margin:0;font-size:15px;color:#0b2c66}
    .mini{font-size:12px;color:var(--muted)}
    canvas.sig{border:1px dashed #cbd5e1;border-radius:10px;background:#fff;touch-action:none}
    @media (max-width:980px){.panels{grid-template-columns:1fr}.col-3,.col-2,.col-4,.col-5,.col-6{grid-column:span 12}.toolbar{flex-direction:column;align-items:stretch}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="display:flex;align-items:center;gap:10px">
        <h1>Parts Inventory & Vehicle Checker</h1>
        <span class="badge">Offline / saves to your device</span>
      </div>
      <div class="toolbar">
        <input id="search" type="search" placeholder="Search parts (part #, name, Y/M/M, vendor, bin, notes)" />
      </div>
    </header>

    <div class="grid panels">
      <!-- Left: Add / edit -->
      <section class="card">
        <h2>Add / Edit Part</h2>
        <form id="part-form">
          <input type="hidden" id="rowId" />
          <div class="row">
            <div class="col-3">
              <label>Year</label>
              <select id="year"></select>
            </div>
            <div class="col-4">
              <label>Make</label>
              <select id="make"></select>
              <div class="custom-wrap" id="makeCustomWrap">
                <input id="makeCustom" placeholder="Custom make" />
              </div>
            </div>
            <div class="col-5">
              <label>Model</label>
              <select id="model"></select>
              <div class="custom-wrap" id="modelCustomWrap">
                <input id="modelCustom" placeholder="Custom model" />
              </div>
            </div>

            <div class="col-6">
              <label>Part name</label>
              <input id="partName" placeholder="e.g. Front bumper cover" />
            </div>
            <div class="col-6">
              <label>Part number</label>
              <input id="partNumber" placeholder="e.g. 5G0-807-217-AG" />
            </div>

            <div class="col-4">
              <label>OEM / Aftermarket</label>
              <select id="oem">
                <option value="OEM">OEM</option>
                <option value="Aftermarket">Aftermarket</option>
              </select>
            </div>
            <div class="col-4">
              <label>Condition</label>
              <select id="condition">
                <option>New</option>
                <option>Used - A</option>
                <option>Used - B</option>
              </select>
            </div>
            <div class="col-4">
              <label>Bin / Location</label>
              <input id="bin" placeholder="e.g. Aisle 2, Bin B4" />
            </div>

            <div class="col-3">
              <label>Qty</label>
              <select id="qty"></select>
              <div class="custom-wrap" id="qtyCustomWrap">
                <input id="qtyCustom" type="number" min="0" placeholder="Custom qty" />
              </div>
            </div>
            <div class="col-5">
              <label>Vendor</label>
              <select id="vendor">
                <option>OEM</option>
                <option>KEYSTONE</option>
                <option>EMPIRE</option>
                <option>OTHER</option>
              </select>
            </div>
            <div class="col-4">
              <label>Photo (optional)</label>
              <input id="photo" type="file" accept="image/*" />
              <div class="hint">You‚Äôll see a small photo icon in the table if a photo is attached.</div>
            </div>

            <div class="col-12">
              <label>Notes</label>
              <input id="notes" placeholder="Any details (color, sensors, trim)" />
            </div>

            <div class="col-12 btns">
              <button type="submit" class="primary" id="btn-save">Save Part (‚åò/Ctrl+S)</button>
              <button type="button" id="btn-reset">Reset</button>
            </div>
          </div>
        </form>
      </section>

      <!-- Right: Vehicle Checker -->
      <section class="card">
        <h2>Vehicle Checker (Do I stock parts for this car?)</h2>
        <div class="row">
          <div class="col-3">
            <label>Year</label>
            <select id="checkYear"></select>
          </div>
          <div class="col-4">
            <label>Make</label>
            <select id="checkMake"></select>
          </div>
          <div class="col-5">
            <label>Model</label>
            <select id="checkModel"></select>
          </div>
          <div class="col-12">
            <label>OR Part number</label>
            <input id="checkPartNumber" placeholder="Type a part # (exact or partial)" />
          </div>
          <div class="col-12 btns">
            <button id="btn-check" class="good">Check Vehicle / Part #</button>
            <button id="btn-clear-check">Clear</button>
          </div>
        </div>
        <div id="check-results" style="margin-top:10px"></div>
      </section>
    </div>

    <!-- Inventory Table -->
    <section class="card" style="margin-top:14px">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
        <h2 style="margin-right:auto">Inventory</h2>
        <span class="muted" id="inv-meta"></span>
      </div>
      <div style="overflow:auto">
        <table id="table">
          <thead>
            <tr>
              <th>üì∑</th><th>Y</th><th>Make</th><th>Model</th><th>Part</th><th>#</th><th>OEM/AM</th><th>Cond</th><th>Bin</th><th>Qty</th><th>Vendor</th><th>Notes</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Parts Return Manager -->
    <section class="card" style="margin-top:14px">
      <div class="section-title">
        <h3>Parts Return</h3>
        <span class="mini">If parts are a bit old but still look returnable, mark as <b>Pending Return</b> and confirm. If not returnable, remove from this list and keep in inventory.</span>
      </div>
      <div class="row" style="margin-bottom:10px">
        <div class="col-6">
          <label>Quick add to Pending Return (manual)</label>
          <div class="row">
            <div class="col-6"><input id="retPart" placeholder="Part name" /></div>
            <div class="col-3"><input id="retNumber" placeholder="Part #" /></div>
            <div class="col-3"><input id="retVendor" placeholder="Vendor" /></div>
            <div class="col-6"><input id="retNotes" placeholder="Notes / reason" /></div>
            <div class="col-3"><input id="retQty" type="number" min="1" value="1" /></div>
            <div class="col-3"><button id="retAdd" class="warn">Add to Pending Return</button></div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <h3 class="mini" style="margin:8px 0">To Return (not yet sent back)</h3>
          <div id="list-toReturn"></div>
        </div>
        <div class="col-12">
          <h3 class="mini" style="margin:12px 0 0">Pending Refund (sent back ‚Äì waiting on payment)</h3>
          <div id="list-pendingRefund"></div>
        </div>
        <div class="col-12">
          <h3 class="mini" style="margin:12px 0 0">Archive (paid)</h3>
          <div id="list-archive"></div>
        </div>
      </div>
    </section>

    <footer>
      <div>All data is stored locally on this device (<span class="kbd">localStorage</span>). Photos & signatures stay local; CSV import/export is disabled.</div>
    </footer>
  </div>

  <!-- Floating Erase All button -->
  <div class="erase-fab">
    <button id="btn-clear" class="danger">Erase ALL data on this device</button>
  </div>

  <!-- Photo Modal -->
  <div class="modal" id="photoModal" onclick="hideModal()">
    <div class="box" onclick="event.stopPropagation()">
      <img id="photoImg" alt="Part photo" />
    </div>
  </div>

  <!-- Signature / Send Modal -->
  <div class="modal" id="sendModal" onclick="hideSendModal()">
    <div class="box" onclick="event.stopPropagation()">
      <h3 style="margin:6px 0 10px">Mark as Sent to Vendor</h3>
      <div class="row">
        <div class="col-4"><label>Driver name</label><input id="sigDriver" placeholder="Driver" /></div>
        <div class="col-4"><label>Date & time</label><input id="sigWhen" type="datetime-local" /></div>
        <div class="col-4"><label>Location / Tracking (optional)</label><input id="sigExtra" placeholder="Tracking # / Notes" /></div>
        <div class="col-12">
          <label>Signature</label>
          <canvas id="sigPad" class="sig" width="700" height="200"></canvas>
          <div class="btns"><button id="sigClear">Clear</button><button class="good" id="sigSave">Confirm & Move to Pending Refund</button></div>
        </div>
      </div>
    </div>
  </div>

  <script>
  // ====== Helpers & Storage ======
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const LS_KEY = 'parts_inventory_whitetheme_returns_v1';

  function loadStore(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return { items: [], toReturn: [], pendingRefund: [], archive: [] };
      const parsed = JSON.parse(raw);
      // Backward compat if we only had items previously
      if(Array.isArray(parsed)) return { items: parsed, toReturn: [], pendingRefund: [], archive: [] };
      return Object.assign({ items: [], toReturn: [], pendingRefund: [], archive: [] }, parsed);
    }catch{ return { items: [], toReturn: [], pendingRefund: [], archive: [] }; }
  }
  let STORE = loadStore();
  function saveStore(){ localStorage.setItem(LS_KEY, JSON.stringify(STORE)); render(); renderReturns(); }

  function uid(){ return Math.random().toString(36).slice(2,10); }
  function esc(s){ return (s??'').toString().replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
  const fmt = v => (v??'').toString().trim();

  // ====== Dropdown Data ======
  const YEARS = Array.from({length:(2025-1990+1)},(_,i)=> String(1990+i));
  const MAKES = ['Acura','Alfa Romeo','Audi','BMW','Buick','Cadillac','Chevrolet','Chrysler','Dodge','Ford','GMC','Honda','Hyundai','Infiniti','Jaguar','Jeep','Kia','Land Rover','Lexus','Lincoln','Mazda','Mercedes-Benz','Mini','Mitsubishi','Nissan','Porsche','Ram','Subaru','Tesla','Toyota','Volkswagen','Volvo'];
  const MODELS = { 'Volkswagen':['GTI','Golf','Jetta','Passat','Tiguan','Atlas'], 'Dodge':['Durango 392','Charger','Challenger','Ram 1500'], 'Tesla':['Model 3','Model Y','Model S','Model X'], 'BMW':['X5','3 Series','5 Series','X3','X7'], 'Honda':['Civic','Accord','CR-V','Pilot'] };

  // ====== Inventory State (compat with old) ======
  let state = STORE.items; // alias for old code paths
  let searchTerm = '';
  let formPhotoData = '';

  const form = $('#part-form');
  const tbody = $('#table tbody');
  const invMeta = $('#inv-meta');

  // ====== Dropdowns ======
  function buildSelect(el, options, {includeCustom=true}={}){
    el.innerHTML = '';
    const opt = v => { const o=document.createElement('option'); o.value=v; o.textContent=v; return o; };
    options.forEach(v=> el.appendChild(opt(v)));
    if(includeCustom) el.appendChild(opt('Custom‚Ä¶'));
  }
  function initDropdowns(){
    buildSelect($('#year'), YEARS, {includeCustom:false});
    buildSelect($('#checkYear'), YEARS, {includeCustom:false});
    buildSelect($('#make'), MAKES, {includeCustom:true});
    buildSelect($('#checkMake'), MAKES, {includeCustom:false});
    buildSelect($('#qty'), Array.from({length:21},(_,i)=> String(i)), {includeCustom:true});
    syncModelOptions($('#make').value || 'Volkswagen');
    syncCheckerModels($('#checkMake').value || 'Volkswagen');
  }
  function syncModelOptions(make){
    const sel = $('#model');
    const list = MODELS[make] || [];
    if(list.length===0){ buildSelect(sel, ['Custom‚Ä¶'], {includeCustom:false}); toggleCustom('model', true); }
    else { buildSelect(sel, list, {includeCustom:true}); toggleCustom('model', false); }
  }
  function syncCheckerModels(make){
    const sel = $('#checkModel');
    const list = MODELS[make] || [];
    sel.innerHTML='';
    (list.length?list:['-']).forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; sel.appendChild(o); });
  }
  function toggleCustom(field, show){ const wrap = $('#'+field+'CustomWrap'); if(!wrap) return; wrap.style.display = show? 'grid':'none'; }
  function setSelectValue(id, value){ const sel=$('#'+id); const found=[...sel.options].some(o=>o.value===value); if(found){ sel.value=value; toggleCustom(id,false);} else{ sel.value='Custom‚Ä¶'; toggleCustom(id,true); const c=$('#'+id+'Custom'); if(c) c.value=value; } }

  // ====== Photo handling ======
  $('#photo').addEventListener('change', async (e)=>{
    const file = e.target.files && e.target.files[0]; if(!file){ formPhotoData=''; return; }
    const dataURL = await fileToDataURL(file, 1200); formPhotoData = dataURL; });
  function fileToDataURL(file, maxW){ return new Promise((resolve,reject)=>{ const r=new FileReader(); r.onload=()=>{ const img=new Image(); img.onload=()=>{ const scale=Math.min(1,maxW/img.width); if(scale>=1) return resolve(r.result); const c=document.createElement('canvas'); c.width=Math.round(img.width*scale); c.height=Math.round(img.height*scale); const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,c.width,c.height); resolve(c.toDataURL('image/jpeg',0.85)); }; img.onerror=()=>resolve(r.result); img.src=r.result; }; r.onerror=reject; r.readAsDataURL(file); }); }

  // ====== CRUD ======
  function readForm(){ return { id: $('#rowId').value || uid(), year: $('#year').value, make: getValue('make'), model: getValue('model'), partName: fmt($('#partName').value), partNumber: fmt($('#partNumber').value), oem: $('#oem').value, condition: $('#condition').value, bin: fmt($('#bin').value), qty: Number($('#qty').value==='Custom‚Ä¶'?($('#qtyCustom').value||0):$('#qty').value), vendor: $('#vendor').value, notes: fmt($('#notes').value), photo: formPhotoData || undefined, createdAt: Date.now(), updatedAt: Date.now() }; }
  function getValue(selId){ const sel=$('#'+selId); if(sel.value==='Custom‚Ä¶'){ const v=fmt($('#'+selId+'Custom').value); return v||'Custom'; } return sel.value; }
  function clearForm(){ form.reset(); $('#rowId').value=''; formPhotoData=''; toggleCustom('make',false); toggleCustom('model',false); toggleCustom('qty',false); }
  function upsert(row){ const i=state.findIndex(r=>r.id===row.id); if(i>=0){ row.createdAt=state[i].createdAt; row.updatedAt=Date.now(); state[i]=row; } else state.unshift(row); if(!MAKES.includes(row.make)&&row.make&&row.make!=='Custom'){ MAKES.push(row.make); } if(row.make){ MODELS[row.make]=MODELS[row.make]||[]; if(!MODELS[row.make].includes(row.model)&&row.model){ MODELS[row.make].push(row.model); } } STORE.items = state; saveStore(); clearForm(); initDropdowns(); }
  function remove(id){ state = state.filter(r=>r.id!==id); STORE.items = state; saveStore(); }

  // ====== Render Inventory ======
  function render(){ const filtered = state.filter(r=>matchesSearch(r,searchTerm)); tbody.innerHTML = filtered.map(r=>rowHtml(r)).join('') || `<tr><td class="muted" colspan="13">No parts yet. Add with the form above.</td></tr>`; invMeta.textContent = `${filtered.length} shown / ${state.length} total`; }
  function matchesSearch(r,q){ if(!q) return true; q=q.toLowerCase(); const fields=[r.year,r.make,r.model,r.partName,r.partNumber,r.oem,r.condition,r.bin,r.vendor,r.notes,r.qty].map(x=>String(x||'').toLowerCase()); return fields.some(f=>f.includes(q)); }
  function rowHtml(r){ const hasPhoto=!!r.photo; return `<tr>
    <td>${hasPhoto?`<button class="icon" title="View photo" onclick="showPhoto('${r.id}')">üñºÔ∏è</button>`:''}</td>
    <td>${esc(r.year)}</td><td>${esc(r.make)}</td><td>${esc(r.model)}</td>
    <td>${esc(r.partName)}</td>
    <td><code class="kbd">${esc(r.partNumber)}</code></td>
    <td>${esc(r.oem)}</td><td>${esc(r.condition)}</td><td>${esc(r.bin)}</td>
    <td>${r.qty}</td><td>${esc(r.vendor)}</td><td>${esc(r.notes)}</td>
    <td>
      <button onclick="editRow('${r.id}')">Edit</button>
      <button class="warn" onclick="startReturnFromInv('${r.id}')">Return</button>
      <button class="danger" onclick="deleteRow('${r.id}')">Delete</button>
    </td>
  </tr>`; }
  window.editRow = id => { const r=state.find(x=>x.id===id); if(r){ fillForm(r); window.scrollTo({top:0,behavior:'smooth'});} };
  function fillForm(r){ $('#rowId').value=r.id; setSelectValue('year',r.year); setSelectValue('make',r.make); syncModelOptions($('#make').value); setSelectValue('model',r.model); $('#partName').value=r.partName; $('#partNumber').value=r.partNumber; $('#oem').value=r.oem; $('#condition').value=r.condition; $('#bin').value=r.bin; setSelectValue('qty',String(r.qty)); if($('#qty').value==='Custom‚Ä¶'){ $('#qtyCustom').value=r.qty; } $('#vendor').value=r.vendor; $('#notes').value=r.notes; formPhotoData=r.photo||''; $('#photo').value=''; }
  window.deleteRow = id => { if(confirm('Delete this part?')) remove(id); };
  window.showPhoto = id => { const r=state.find(x=>x.id===id); if(!r||!r.photo) return; $('#photoImg').src=r.photo; $('#photoModal').style.display='flex'; };
  window.hideModal = ()=> $('#photoModal').style.display='none';

  // Events
  form.addEventListener('submit', e=>{ e.preventDefault(); const row=readForm(); if(!row.partName){ alert('Part Name is required'); return;} upsert(row); });
  $('#btn-reset').addEventListener('click', clearForm);
  document.addEventListener('keydown', e=>{ if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='s'){ e.preventDefault(); $('#btn-save').click(); }});
  $('#search').addEventListener('input', e=>{ searchTerm=e.target.value; render(); });
  $('#make').addEventListener('change', e=>{ toggleCustom('make',e.target.value==='Custom‚Ä¶'); syncModelOptions(e.target.value); });
  $('#model').addEventListener('change', e=> toggleCustom('model', e.target.value==='Custom‚Ä¶'));
  $('#qty').addEventListener('change', e=> toggleCustom('qty', e.target.value==='Custom‚Ä¶'));

  // Erase All
  $('#btn-clear').addEventListener('click', ()=>{ if(confirm('Erase ALL saved data on this device (inventory + returns + photos + signatures)?')){ STORE={items:[],toReturn:[],pendingRefund:[],archive:[]}; state=STORE.items; saveStore(); initDropdowns(); }});

  // ====== Vehicle Checker ======
  $('#checkMake').addEventListener('change', e=> syncCheckerModels(e.target.value));
  $('#btn-check').addEventListener('click', ()=>{
    const pn = fmt($('#checkPartNumber').value).toLowerCase();
    let results=[];
    if(pn){ results = state.filter(r=> String(r.partNumber||'').toLowerCase().includes(pn)); }
    else{
      const y=$('#checkYear').value, mk=$('#checkMake').value, md=$('#checkModel').value;
      results = state.filter(r=>{ const yOk = y? String(r.year)===String(y):true; const mOk = mk && mk!=='-'? String(r.make||'')===mk:true; const dOk = md && md!=='-'? String(r.model||'')===md:true; return yOk&&mOk&&dOk; });
    }
    const box=$('#check-results');
    if(results.length===0){ box.innerHTML='<div class="muted">No matches found.</div>'; return; }
    box.innerHTML = `<div style="margin-bottom:8px">Found <b>${results.length}</b> matching part(s):</div>`+
      `<div style="display:grid;gap:10px">`+
      results.map(r=>`<div class="card" style="padding:10px">`+
        `<div style="display:flex;gap:8px;align-items:center"><span class="pill">${esc(r.year)} ${esc(r.make)} ${esc(r.model)}</span>`+
        `<span class="pill">Bin: ${esc(r.bin||'-')}</span>`+
        `<span class="pill">Qty: ${r.qty}</span></div>`+
        `<div style="margin-top:6px"><b>${esc(r.partName)}</b> <span class="muted">#${esc(r.partNumber||'-')}</span></div>`+
        `<div class="muted">${esc(r.oem)} ‚Ä¢ ${esc(r.condition)} ‚Ä¢ Vendor: ${esc(r.vendor||'-')}</div>`+
      `</div>`).join('')+`</div>`;
  });
  $('#btn-clear-check').addEventListener('click', ()=>{ $('#checkYear').value=''; $('#checkMake').value=''; $('#checkModel').innerHTML=''; $('#checkPartNumber').value=''; $('#check-results').innerHTML=''; });

  // ====== Returns Manager ======
  const listToReturn = $('#list-toReturn');
  const listPendingRefund = $('#list-pendingRefund');
  const listArchive = $('#list-archive');

  // Quick add manual pending return
  $('#retAdd').addEventListener('click', ()=>{
    const rec = { id: uid(), partName: fmt($('#retPart').value), partNumber: fmt($('#retNumber').value), vendor: fmt($('#retVendor').value), qty: Number($('#retQty').value||1), notes: fmt($('#retNotes').value), createdAt: Date.now(), status: 'toReturn' };
    if(!rec.partName && !rec.partNumber){ alert('Enter at least a Part name or Part #'); return; }
    STORE.toReturn.unshift(rec); saveStore();
    $('#retPart').value = $('#retNumber').value = $('#retVendor').value = $('#retNotes').value = ''; $('#retQty').value = 1;
  });

  // Start return from inventory row
  window.startReturnFromInv = id =>{
    const r = state.find(x=>x.id===id); if(!r) return;
    const rec = { id: uid(), itemId: r.id, partName: r.partName, partNumber: r.partNumber, vendor: r.vendor, qty: Math.max(1, Number(r.qty||1)), notes: `From inventory bin ${r.bin||'-'}`, createdAt: Date.now(), status:'toReturn' };
    STORE.toReturn.unshift(rec); saveStore(); window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
  };

  function renderReturns(){
    listToReturn.innerHTML = STORE.toReturn.length? STORE.toReturn.map(r=>retCard(r,'toReturn')).join('') : `<div class="muted">Nothing waiting to be returned.</div>`;
    listPendingRefund.innerHTML = STORE.pendingRefund.length? STORE.pendingRefund.map(r=>retCard(r,'pendingRefund')).join('') : `<div class="muted">No items waiting on refund.</div>`;
    listArchive.innerHTML = STORE.archive.length? STORE.archive.map(r=>retCard(r,'archive')).join('') : `<div class="muted">Archive is empty.</div>`;
  }

  function retCard(r, where){
    const base = `<div class="card" style="padding:10px;margin:8px 0">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <span class="pill">${esc(r.partName || '-')}</span>
        <span class="pill">#${esc(r.partNumber || '-')}</span>
        <span class="pill">Vendor: ${esc(r.vendor || '-')}</span>
        <span class="pill">Qty: ${esc(r.qty || 1)}</span>
        ${r.driver? `<span class="pill">Driver: ${esc(r.driver)}</span>`:''}
        ${r.takenAt? `<span class="pill">Sent: ${new Date(r.takenAt).toLocaleString()}</span>`:''}
      </div>
      <div class="mini" style="margin-top:6px">${esc(r.notes || '')}</div>`;

    if(where==='toReturn'){
      return base + `<div class="btns" style="margin-top:8px">
        <button class="good" onclick="openSend('${r.id}')">Mark Sent (sign)</button>
        <button onclick="editPending('${r.id}')">Edit</button>
        <button class="danger" onclick="removePending('${r.id}')">Remove</button>
      </div></div>`;
    }
    if(where==='pendingRefund'){
      return base + `<div class="btns" style="margin-top:8px">
        <button class="warn" onclick="viewSignature('${r.id}')">View Signature</button>
        <button class="good" onclick="markPaid('${r.id}')">Paid ‚Üí Archive</button>
        <button class="danger" onclick="cancelRefund('${r.id}')">Cancel & Back to To Return</button>
      </div></div>`;
    }
    return base + `</div>`; // archive
  }

  window.editPending = id =>{
    const r = STORE.toReturn.find(x=>x.id===id); if(!r) return;
    const v = prompt('Edit notes / reason:', r.notes||''); if(v===null) return; r.notes = v; saveStore();
  };
  window.removePending = id =>{ if(confirm('Remove from Pending Return list?')){ STORE.toReturn = STORE.toReturn.filter(x=>x.id!==id); saveStore(); } };

  // ====== Send (Signature) Flow ======
  let sendCtx = { id:null };
  const sendModal = $('#sendModal');
  const sigPad = $('#sigPad');
  const ctx = sigPad.getContext('2d'); ctx.lineWidth = 2; ctx.lineCap='round';
  let drawing=false, last=null;
  function pos(e){ const r=sigPad.getBoundingClientRect(); const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left; const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top; return {x,y}; }
  function startDraw(e){ drawing=true; last=pos(e); }
  function moveDraw(e){ if(!drawing) return; const p=pos(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; }
  function endDraw(){ drawing=false; }
  sigPad.addEventListener('mousedown',startDraw); sigPad.addEventListener('mousemove',moveDraw); window.addEventListener('mouseup',endDraw);
  sigPad.addEventListener('touchstart',startDraw,{passive:true}); sigPad.addEventListener('touchmove',moveDraw,{passive:true}); sigPad.addEventListener('touchend',endDraw);
  $('#sigClear').addEventListener('click', ()=>{ ctx.clearRect(0,0,sigPad.width,sigPad.height); });

  window.openSend = id =>{
    sendCtx.id = id; $('#sigDriver').value=''; const now=new Date(); $('#sigWhen').value = new Date(now.getTime()-now.getTimezoneOffset()*60000).toISOString().slice(0,16); $('#sigExtra').value=''; ctx.clearRect(0,0,sigPad.width,sigPad.height); sendModal.style.display='flex'; };
  window.hideSendModal = ()=> sendModal.style.display='none';
  $('#sigSave').addEventListener('click', ()=>{
    const rec = STORE.toReturn.find(x=>x.id===sendCtx.id); if(!rec) return;
    const driver = fmt($('#sigDriver').value); if(!driver){ alert('Enter driver name'); return; }
    const when = $('#sigWhen').value ? new Date($('#sigWhen').value).getTime() : Date.now();
    const extra = fmt($('#sigExtra').value);
    const signature = sigPad.toDataURL('image/png');
    const moved = Object.assign({}, rec, { driver, takenAt: when, extra, signature, status:'pendingRefund' });
    STORE.toReturn = STORE.toReturn.filter(x=>x.id!==rec.id);
    STORE.pendingRefund.unshift(moved);
    saveStore(); hideSendModal();
  });

  window.viewSignature = id =>{
    const r = STORE.pendingRefund.find(x=>x.id===id); if(!r||!r.signature) return alert('No signature on file.');
    $('#photoImg').src = r.signature; $('#photoModal').style.display='flex';
  };
  window.cancelRefund = id =>{
    const r = STORE.pendingRefund.find(x=>x.id===id); if(!r) return;
    if(confirm('Move this back to To Return?')){ STORE.pendingRefund = STORE.pendingRefund.filter(x=>x.id!==id); delete r.signature; delete r.driver; delete r.takenAt; STORE.toReturn.unshift(r); saveStore(); }
  };
  window.markPaid = id =>{
    const r = STORE.pendingRefund.find(x=>x.id===id); if(!r) return;
    r.paidAt = Date.now(); STORE.pendingRefund = STORE.pendingRefund.filter(x=>x.id!==id); STORE.archive.unshift(r); saveStore();
  };

  // ====== Kickoff ======
  function initialRender(){ initDropdowns(); render(); renderReturns(); }
  initialRender();
  </script>
</body>
</html>
